本文介绍 TDSQL-C MySQL 版数据库代理的防闪断功能。

## 背景信息
数据库实例在运维过程中，总会根据需要，进行相应的调整，如变更配置、计划内 HA 切换、计划内重启等，这些行为可能会中断用户会话，导致连接闪断、新建连接短暂失败等问题。TDSQL-C MySQL 版数据库代理提供防闪断能力，在数据库实例进行有损切换、转移时，可以提供无损的应用连续性，避免连接和事务的中断。

## 实现原理
防闪断能力，使用了 session track 功能，当感知到计划内的有损行为时，数据库代理会与切换前的主节点断开连接，将客户端到数据库代理上的连接，恢复至切换后主节点的连接上，通过 session track 能力将会话相关的系统变量、用户变量、字符集编码信息转移至新的后端连接上，实现对应用程序端无损切换。
![](https://qcloudimg.tencent-cloud.cn/raw/5f2a8e94f3a484315bd6ead6f4de3b86.png)

## 注意事项
- 当语句中使用了临时表（因临时表和每个会话相关联），会无法恢复连接，直接报错。
- 防闪断能力会自动将超过3秒的事务中止。
- 当连接切换时，如果数据库代理正在从数据库接收结果报文，但是主备切换导致报文仅传输了部分数据，此时，防闪断无法继续保持连接。
